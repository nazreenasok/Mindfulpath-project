<html>
  <head>
    <title>Schedule Appointment</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght%40400%3B500%3B700%3B900&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
    <style>
      .selected-date div { background-color: #000 !important; color: #fff !important; border-radius: 9999px; }
    </style>
  </head>
  <body>
    <div class="relative flex size-full min-h-screen flex-col bg-neutral-50 group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
        <div class="layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#ededed] px-10 py-3">
                <div class="flex items-center gap-4 text-[#141414]">
                    <h2 class="text-[#141414] text-lg font-bold leading-tight tracking-[-0.015em]"><a href="/">MindfulPath</a></h2>
                </div>
                 <div class="flex flex-1 justify-end gap-8">
                    <div class="flex items-center gap-9">
                      <a class="text-[#141414] text-sm font-medium leading-normal hover:text-blue-600 transition-all" href="/about-us">About Us</a>
		      <a class="text-[#141414] text-sm font-medium leading-normal hover:text-blue-600 transition-all" href="/services">Services</a>
		      <a class="text-blue-600 text-sm font-medium leading-normal hover:text-blue-700 transition-all" href="/contact-us">Contact</a>
                    </div>
                </div>
            </header>
            <div class="px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                    <div class="flex flex-wrap justify-between gap-3 p-4">
                      <p class="text-[#141414] tracking-light text-[32px] font-bold leading-tight min-w-72">Book Your Appointment</p>
                    </div>
                     <h2 class="text-[#141414] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Select Age Group</h2>
                    <div class="flex flex-wrap gap-3 p-4" id="age-group-options">
                      <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                        Children (0-18)
                        <input type="radio" class="invisible absolute" name="age-group" />
                      </label>
                      <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                        Adults (18+)
                        <input type="radio" class="invisible absolute" name="age-group" />
                      </label>
                    </div>
                    <h2 class="text-[#141414] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Select Service</h2>
                    <div class="flex flex-wrap gap-3 p-4" id="service-options">
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Developmental/Learning Disability Consultations
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Neurodivergence Support
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Psychological and Psychiatric Services (Anxiety, Depression, PTSD, Schizophrenia, Bipolar Disorder)
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Occupational Therapy
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Speech/Language Therapy
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Educational Therapy
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Art Therapy
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Music Therapy
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Neurofeedback Therapy
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            Couples Counseling (Adults Only)
                            <input type="radio" class="invisible absolute" name="service" />
                        </label>
                    </div>
                    <h2 class="text-[#141414] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Select Date</h2>
                    <div class="flex flex-wrap items-start justify-center gap-6 p-4">
                      <div class="flex min-w-72 max-w-[336px] flex-1 flex-col gap-0.5">
                        <div class="flex items-center p-1 justify-between">
                          <button id="prev-month-btn">
                            <div class="text-[#141414] flex size-10 items-center justify-center">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256"><path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path></svg>
                            </div>
                          </button>
                          <p class="text-[#141414] text-base font-bold leading-tight flex-1 text-center" id="month-year"></p>
                           <button id="next-month-btn">
                            <div class="text-[#141414] flex size-10 items-center justify-center">
                              <svg xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" fill="currentColor" viewBox="0 0 256 256"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path></svg>
                            </div>
                          </button>
                        </div>
                        <div class="grid grid-cols-7" id="calendar-grid"></div>
                      </div>
                    </div>
                    <h2 class="text-[#141414] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Select Time</h2>
                    <div class="flex flex-wrap gap-3 p-4" id="time-options">
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            9:00 AM
                            <input type="radio" class="invisible absolute" name="time" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            10:00 AM
                            <input type="radio" class="invisible absolute" name="time" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            11:00 AM
                            <input type="radio" class="invisible absolute" name="time" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            1:00 PM
                            <input type="radio" class="invisible absolute" name="time" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            2:00 PM
                            <input type="radio" class="invisible absolute" name="time" />
                        </label>
                        <label class="text-sm font-medium leading-normal flex items-center justify-center rounded border border-[#dbdbdb] px-4 h-11 text-[#141414] has-[:checked]:border-[3px] has-[:checked]:px-3.5 has-[:checked]:border-black relative cursor-pointer">
                            3:00 PM
                            <input type="radio" class="invisible absolute" name="time" />
                        </label>
                    </div>
                    <div class="flex px-4 py-3 justify-center">
                        <button
                            id="proceed-to-payment-button"
                            class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded h-12 px-5 bg-black text-neutral-50 text-base font-bold leading-normal tracking-[0.015em]">
                            <span class="truncate">Proceed to Payment</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // --- CALENDAR LOGIC ---
        const monthYearElement = document.getElementById('month-year');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        let currentDate = new Date();
        window.selectedDate = null; // Use window scope to be accessible in payment logic
        const timeLabels = document.querySelectorAll('#time-options label');

        // NEW: Function to update available time slots based on the selected date
        function updateAvailableTimes(selectedDate) {
            const now = new Date();
            const isToday = selectedDate.toDateString() === now.toDateString();

            timeLabels.forEach(label => {
                const input = label.querySelector('input');
                const timeText = label.textContent.trim();
                const [time, modifier] = timeText.split(' ');
                let [hours, minutes] = time.split(':').map(Number);
                if (modifier === 'PM' && hours < 12) hours += 12;

                const isPastTime = isToday && hours <= now.getHours();

                if (isPastTime) {
                    input.disabled = true;
                    if (input.checked) input.checked = false; // Uncheck if selected
                    label.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    input.disabled = false;
                    label.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        function renderCalendar() {
          calendarGrid.innerHTML = ''; 
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          monthYearElement.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
          
          // NEW: Logic to disable previous month button
          const today = new Date();
          const isCurrentMonth = year === today.getFullYear() && month === today.getMonth();
          if (isCurrentMonth) {
              prevMonthBtn.disabled = true;
              prevMonthBtn.classList.add('opacity-50', 'cursor-not-allowed');
          } else {
              prevMonthBtn.disabled = false;
              prevMonthBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
          
          const daysOfWeek = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
          daysOfWeek.forEach(day => {
            const dayHeader = document.createElement('p');
            dayHeader.className = 'text-[#141414] text-[13px] font-bold leading-normal flex h-12 w-full items-center justify-center pb-0.5';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
          });
          const firstDayOfMonth = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          for (let i = 0; i < firstDayOfMonth; i++) {
             const emptyCell = document.createElement('div');
             calendarGrid.appendChild(emptyCell);
          }
          for (let day = 1; day <= daysInMonth; day++) {
            const dayButton = document.createElement('button');
            dayButton.className = 'h-12 w-full text-[#141414] text-sm font-medium leading-normal';
            dayButton.innerHTML = `<div class="flex size-full items-center justify-center rounded-full">${day}</div>`;
            dayButton.dataset.day = day;

            // NEW: Logic to disable past dates
            const loopDate = new Date(year, month, day);
            const isPastDate = loopDate < new Date(today.getFullYear(), today.getMonth(), today.getDate());
            if (isPastDate) {
                dayButton.disabled = true;
                dayButton.classList.add('text-gray-400', 'pointer-events-none');
            }

            if (window.selectedDate && window.selectedDate.getDate() === day && window.selectedDate.getMonth() === month && window.selectedDate.getFullYear() === year) {
                dayButton.classList.add('selected-date');
            }
            dayButton.addEventListener('click', () => {
                if (isPastDate) return; // Extra safety
                const prevSelected = document.querySelector('.selected-date');
                if(prevSelected) {
                    prevSelected.classList.remove('selected-date');
                }
                window.selectedDate = new Date(year, month, day);
                dayButton.classList.add('selected-date');
                updateAvailableTimes(window.selectedDate); // NEW: Update times on date selection
            });
            calendarGrid.appendChild(dayButton);
          }
        }
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });
        renderCalendar();

        // --- CASHFREE PAYMENT LOGIC ---
        const cashfree = new Cashfree({
            mode:"sandbox" // Ensure this is set to sandbox for testing
        });
        const paymentButton = document.getElementById('proceed-to-payment-button');

        paymentButton.addEventListener('click', async (event) => {
          event.preventDefault();
          const selectedService = document.querySelector('#service-options input[name="service"]:checked');
          const selectedTime = document.querySelector('#time-options input[name="time"]:checked');
          
          // MODIFIED: Format date to YYYY-MM-DD for easier backend processing
          const date = window.selectedDate 
              ? `${window.selectedDate.getFullYear()}-${String(window.selectedDate.getMonth() + 1).padStart(2, '0')}-${String(window.selectedDate.getDate()).padStart(2, '0')}`
              : null;

          if (!selectedService || !date || !selectedTime) {
            alert('Please select a service, date, and time before proceeding.');
            return;
          }
          const serviceName = selectedService.parentElement.textContent.trim();
          const timeValue = selectedTime.parentElement.textContent.trim();

          try {
            const response = await fetch('/create-cashfree-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                  service: serviceName,
                  date: date, // Send formatted date
                  time: timeValue // Send time
              }),
            });
            const result = await response.json();
            
            if (result.error) {
                alert(`Error: ${result.error}`);
                return;
            }
            
            const paymentSessionId = result.payment_session_id;

            cashfree.checkout({
                paymentSessionId: paymentSessionId,
                redirectTarget: "_self" // Redirect in the same tab after payment
            }).then((result) => {
                if (result.error) {
                    // This will be called if the user closes the popup
                    console.log("User closed the payment popup");
                    window.location.href = "/cancel";
                }
            });
          } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while setting up payment.');
          }
        });
      });
    </script>
    </body>
</html>